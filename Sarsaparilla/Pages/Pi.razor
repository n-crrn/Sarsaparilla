@page "/pi"

@using AppliedPi
@using AppliedPi.Translate
@using StatefulHorn
@using SarsaWidgets

<PageTitle>Applied π Interface</PageTitle>

<PaneStack>
    <Pane Title='Editor'>
        <ButtonBarItems>
            <button @onclick=Parse>Parse</button>
        </ButtonBarItems>
        <Body>
            <div class='editor-pane-contents'>
                <AppliedPiEditor @bind-Text=AppliedPiSource />
                @if (ErrorMessage != null)
                {
                    <div class='compile-error-message'>
                        @ErrorMessage
                    </div>
                }
            </div>
        </Body>
    </Pane>

    <Pane Title='Parsed π Model'>
        <ButtonBarItems>
            <button @onclick=Query disabled=@QueryDisabled>Query</button>
        </ButtonBarItems>
        <Body>
            <div class='parse-pane-contents'>
                <div class='parsed-network-block'>
                    <h4>Unresolved Network</h4>
                    <NetworkDisplay Network=@ParsedNetwork/>
                </div>
                <div class='resolved-network-block'>
                    <h4>Resolved Network</h4>
                    <ResolvedNetworkDisplay ResolvedNetwork=@FullyResolvedNetwork/>
                </div>
                @if (Translation != null)
                {
                    <div class='rules-block'>
                        <h4>Rules Generated</h4>
                        <h5>Queries</h5>
                        <div class='query-block'>
                            @foreach (IMessage q in Translation.Queries)
                            {
                                <div class='query-message'>@q</div>
                            }
                        </div>
                        <h5>Initial States</h5>
                        <div class='initial-state-block'>
                            @foreach (State s in Translation.InitialStates)
                            {
                                <div class='initial-state'>@s</div>
                            }
                        </div>
                        @foreach (Rule r in Translation.Rules)
                        {
                            <RuleDisplay Rule=@r/>
                        }
                    </div>
                }
            </div>
        </Body>
    </Pane>

    <Pane Title='Query Result'>
        <Body>
            @if (Engine != null)
            {
                <QueryEngineDisplay @ref=QEDisplay Engine=@Engine/>
            }
            else
            {
                <p class='no-engine-message'>Query the model to continue.</p>
            }
        </Body>
    </Pane>
</PaneStack>

@code {
    public string AppliedPiSource { get; set; } = "";

    public string? ErrorMessage { get; set; }

    public Network? ParsedNetwork { get; set; }

    public ResolvedNetwork? FullyResolvedNetwork { get; set; }

    public Translation? Translation { get; set; }

    private void Parse()
    {
        try
        {
            ErrorMessage = null;
            ParsedNetwork = null;
            FullyResolvedNetwork = null;
            ParsedNetwork = Network.CreateFromCode(AppliedPiSource);
            FullyResolvedNetwork = ResolvedNetwork.From(ParsedNetwork);
            Translation = Translation.From(FullyResolvedNetwork, ParsedNetwork);

            List<QueryEngine> engines = new(Translation.QueryEngines());
            if (engines.Count > 0)
            {
                Engine = engines[0];
            }
        }
        catch (NetworkCreationException ex)
        {
            ErrorMessage = ex.Message;
        }
    }

    private QueryEngine? Engine = null;

    private QueryEngineDisplay? _QEDisplay;

    private QueryEngineDisplay? QEDisplay {
        get => _QEDisplay;
        set
        {
            // Disconnection completed callback.
            if (value != null)
            {
                _QEDisplay = value;
            }
            // Reconnect completed callback.
        }
    }

    public bool QueryDisabled => Engine == null;

    private void Query()
    {
        QEDisplay!.ExecuteQuery();
    }
}
